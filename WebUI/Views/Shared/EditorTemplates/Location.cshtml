@model EditorViewModel
@using Base.EntityFrameworkTypes.Complex

@{
    LayerType layerType = LayerType.All;

    if (ViewData["LayerType"] != null && ViewData["LayerType"] is LayerType)
    {
        layerType = (LayerType)ViewData["LayerType"];
    }

    string wrapID = "n_" + Guid.NewGuid().ToString("N");

    string mapID = "n_" + Guid.NewGuid().ToString("N");

    string addressWrapID = "n_" + Guid.NewGuid().ToString("N");

    string addressInputID = "n_" + Guid.NewGuid().ToString("N");

    string wndID = "wnd_" + Guid.NewGuid().ToString("N");

    string latlngPolyWndID = "wnd_" + Guid.NewGuid().ToString("N");

    string latlngPointWndID = "wnd_" + Guid.NewGuid().ToString("N");

    string htmlFieldName = Model.PropertyName;

    string addressHtmlFieldName = htmlFieldName + ".Address";

    IDictionary<string, object> attributes = new Dictionary<string, object>();

    attributes.Add("class", "k-textbox address-autocomplite");
    attributes.Add("id", addressInputID);
    attributes.Add("placeholder", "Введите адрес");
    attributes.Add("style", "width: 100%;");
    attributes.Add("data-bind", "value:" + addressHtmlFieldName + ".Lang.ru");

    var controller = this.ViewContext.Controller as WebUI.Controllers.IBaseController;

    string[] language = controller.SettingService.GetValue(Data.Consts.Settings.LANGUAGE, "en").ToString().Split(';');
}

<script>
    $(function () {
        window["@addressWrapID"] = {
            edit: function () {
                var wnd = $("#@wndID").data("kendoWindow");
                wnd.setOptions({
                    width: $("#@addressWrapID").find("#@addressInputID").width() + 100
                });
                wnd.center();
                wnd.open();
            },
            translate: function (lang, id) {
                var text = $("#@addressWrapID").find("#@addressInputID").val();
                var $el = $("#" + id);
                $el.val("");
                pbaAPI.translate(text, "ru", lang, function (res) {
                    window["@wndID"].form.setPr("Lang." + lang, res);
                    $el.val(res);
                });
            }
        };

        window["@wndID"] = {

            onOpen: function (e) {
                var form = $("#@wrapID").closest("form").data("pbaForm");
                var wnd = e.sender;
                var lang = $.extend({}, form.getPr("@addressHtmlFieldName"));
                var viewModel = kendo.observable({
                    model: lang,
                    save: function () {
                        var wndForm = wnd.element.find("form").data("pbaForm");
                        form.setPr("@addressHtmlFieldName", wndForm.getModel());
                        wnd.close();
                    },
                    close: function () {
                        wnd.close();
                    }
                });
                if (!wnd["_init__"]) {
                    wnd.element.find(".form").wrap("<form>");
                    var $wndForm = wnd.element.find("form");
                    $wndForm.addClass("common-form");
                    buttons = {
                        "ОК": {
                            "click": "save",
                            icon: "k-update",
                            cssClass: "btn-primary"
                        },
                        "Отмена": {
                            "click": "close",
                            icon: "k-cancel",
                            cssClass: "btn-default"
                        }
                    };
                    $wndForm.pbaForm({
                        model: viewModel,
                        wrap: "k-edit-form-container",
                        buttons: buttons,
                        nameModel: "model",
                        attrBind: true
                    });
                    $wndForm.data("pbaForm").bind();
                    wnd["_init__"] = true;
                } else {
                    var $wndForm = wnd.element.find("form");
                    $wndForm.data("pbaForm").unbind();
                    $wndForm.data("pbaForm").bind(viewModel);
                }
                window["@wndID"].form = $wndForm.data("pbaForm");
            }
        };
    });
</script>

<div id="@wrapID" style="position:absolute; top:0; bottom:0; left:0; right:0">
    <div class="col-md-9 col-md-offset-1 geosearch-wrapper" id="@addressWrapID">
        @Html.TextBox(Model, attributes)
        <span class="k-icon icon-flag-ru" style="position: absolute; left: 25px; top: 10px;"></span>
        <a class="editorOneBtn" onclick="window['@addressWrapID'].edit(); return false;"><span class="halfling halfling-globe" role="button"></span></a>
        @(Html.Kendo().Window()
                .Name(wndID)
                .Title("Локализация - " + Model.Title)
                .Visible(false)
                .Modal(true)
                .Width(400)
                .Height(300)
                .Events(e => e.Open(wndID + ".onOpen"))
                .Content(@<text>
                    <div class="form">
                        <div class="tab-content common-tab" style="top: 10px;">
                            <div class="tab-pane container active">
                                @foreach (string lang in language.Where(l => l.Trim() != ""))
                                {
                                    string id = "l_" + Guid.NewGuid().ToString("N");
                                    <div class="row e-row">
                                        <div class="col-md-12 e-editor">
                                            @Html.TextBox(Model, new { @class = "k-textbox", id = id, style = "width: 100%; padding-left: 25px; padding-right: 45px;", data_bind = "value: Lang." + lang })
                                            <span class="k-icon icon-flag-@lang" style="position: absolute; left: 20px; top: 10px;"></span>
                                            <a class="editorOneBtn" onclick="window['@addressWrapID'].translate('@lang', '@id'); return false;"><span class="halfling halfling-transfer" role="button"></span></a>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </text>)
        )
        @*<span class="halfling halfling-remove"></span>*@
    </div>

    @(Html.Kendo().Window()
        .Name(latlngPolyWndID)
        .Title("Точные координаты")
        .Visible(false)
        .Modal(true)
        .Width(1000)
        .Height(700)
        .HtmlAttributes(new { style = "padding: 0;" })
        .Resizable()
        .Draggable(true)
        .Content(@<text>
            <div id="polylatlngs">
                <div data-role="grid"
                     data-toolbar="['create', 'save']"
                     data-bind="source: latlngs, events: { saveChanges: onSaveChanges }"
                     data-editable="true"
                     data-height="650"
                     data-columns='[{ "field": "lat", title: "Широта" }, { "field" : "lng", title: "Долгота" }, { command: [{ name: "destroy", text: "Удалить" }], title: "", width: "115px" }]'>
                </div>
            </div>
        </text>)
    )

    @(Html.Kendo().Window()
        .Name(latlngPointWndID)
        .Title("Координаты точки")
        .Visible(false)
        .Modal(true)
        .Width(550)
        .Height(120)
        .Draggable(true)
        .Content(@<text>
            <div id="pointlatlngs" style="padding:10px">
                <div>
                    <label for="">Широта</label>
                    <input style="margin-left:10px" class="k-textbox" data-bind="value: model.lat" placeholder="Широта">
                    <label style="margin-left:20px" for="">Долгота</label>
                    <input style="margin-left:10px" class="k-textbox" data-bind="value: model.lng" placeholder="Долгота">
                </div>
                <div style="margin-top: 10px; border-top: 1px solid #ddd; padding-top: 10px;">
                    <button data-bind="click: savePoint" style="float:right;" id="savepointlatlngs" class="btn btn-primary" name="name">Сохранить изменения</button>
                </div>
            </div>
        </text>)
    )

    <div class="lat-lng">
        <div class="lat-lng-wrap">
            <span class="label label-default">Широта</span>
            <span class="label label-primary lat"></span>
        </div>
        <div class="lat-lng-wrap" style="margin-top:50px;">
            <span class="label label-default">Долгота</span>
            <span class="label label-primary lng"></span>
        </div>
    </div>

    <div id="@mapID" style="position:absolute; top:0; bottom:0; left:0; right:0"></div>
</div>

<script>
    $(function () {
        window.onkeydown = function (e) {
            if (e.ctrlKey) {
                window["@wrapID"].showlatlng = true;
                $("#@wrapID").find(".lat-lng").show();
            }
        }
        window.onkeyup = function (e) {
            if (e.keyCode == 17) {
                window["@wrapID"].showlatlng = false;
                $("#@wrapID").find(".lat-lng").hide();
            }
        }


        window["@wrapID"] = {
            layers: {
                OSM: null,
                yandex: null,
                objectLayers: null
            },
            allows: {
                point: "@(layerType.HasFlag(LayerType.Point) ? "true" : "false")" == "true",
                polyline: "@(layerType.HasFlag(LayerType.PolyLine) ? "true" : "false")" == "true",
                poloygon: "@(layerType.HasFlag(LayerType.Polygon) ? "true" : "false")" == "true",
            },
            drawControl: null,
            map: null,
            defaultLatLng: [53.2006600, 45.0046400],
            searchURL: 'https://geocode-maps.yandex.ru/1.x/',
            reverseSearchURL: 'https://geocode-maps.yandex.ru/1.x/',
            osmTileURL: 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            attribution: '<div class="copyBlock">' +
                    '<a class="copy" target="_blank" href="http://pba.su">' +
                    '<img src="/content/images/pba.png"></a>' +
                    '</div>',
            clearMap: function () {
                this.layers.objectLayers.clearLayers();
            },
            //markerIcon: new LeafIcon({
            //    iconUrl: 'http://leafletjs.com/docs/images/leaf-green.png'
            //}),
            showlatlng: false,
            latlngDisplay: $("#@wrapID").find(".lat-lng"),
            latDisplay: $("#@wrapID").find(".lat-lng .lat"),
            lngDisplay: $("#@wrapID").find(".lat-lng .lng"),
            onMapMouseMove: function (event) {
                window["@wrapID"].latlngDisplay.css({
                    top: event.containerPoint.y - 45,
                    left: event.containerPoint.x - 220,
                });
                window["@wrapID"].latDisplay.html(event.latlng.lat);
                window["@wrapID"].lngDisplay.html(event.latlng.lng);
            },
            openAccuratePointWindow: function () {
                var wnd = $("#@latlngPointWndID").data("kendoWindow");
                wnd.setOptions({
                    open: window["@wrapID"]._onAccuratePointOpen
                });
                wnd.center().open();
            },
            openAccuratePolylineWindow: function () {
                var wnd = $("#@latlngPolyWndID").data("kendoWindow");
                wnd.setOptions({
                    title: "Координаты ломанной",
                    open: window["@wrapID"]._onAccuratePolylineOpen
                });
                wnd.center().open();
            },
            openAccuratePolygonWindow: function () {
                var wnd = $("#@latlngPolyWndID").data("kendoWindow");
                wnd.setOptions({
                    title: "Координаты полигона",
                    open: window["@wrapID"]._onAccuratePolygonOpen
                });
                wnd.center().open();
            },
            _bindAccuratePoly: function (model, onSaveChanges) {
                kendo.bind($("#@latlngPolyWndID").find("#polylatlngs"), kendo.observable({
                    latlngs: new kendo.data.DataSource({
                        data: model,
                        schema: {
                            model: {
                                id: "id",
                                fields: {
                                    lat: {
                                        title: "Широта",
                                        editable: true,
                                        type: "string",
                                        validation: { required: true },
                                    },
                                    lng: {
                                        title: "Долгота",
                                        editable: true,
                                        type: "string",
                                        validation: { required: true }
                                    }
                                }
                            }
                        }
                    }),
                    onSaveChanges: onSaveChanges
                }));
            },
            _onAccuratePointOpen: function (e) {
                var layer = window["@wrapID"].layers.objectLayers.getLayers()[0];
                var model = {};
                if (layer) {
                    if (layer._latlng) {
                        model = {
                            lat: layer._latlng.lat,
                            lng: layer._latlng.lng,
                        }
                    } else if (layer._latlngs && layer._latlngs.length) {
                        model = {
                            lat: layer._latlngs[0].lat,
                            lng: layer._latlngs[0].lng,
                        }
                    }
                }

                var observ = kendo.observable({
                    model: model,
                    savePoint: function (e) {
                        var wrap = window["@wrapID"];
                        var latlng = wrap._arraylatlngsToDoubles([this.model]);
                        $("#@latlngPointWndID").data("kendoWindow").close();
                        wrap.clearMap();
                        var wkt = wrap.latlngsToWKT(latlng, true);
                        if (wkt) {
                            wrap.draw(wkt, true);
                            wrap.setGetAddressOfPolygonByCenter(latlng);
                        }
                    }
                });
                var form = $("#@latlngPointWndID").find("#pointlatlngs");
                kendo.bind(form, observ);
            },
            _onAccuratePolygonOpen: function (e) {
                var layer = window["@wrapID"].layers.objectLayers.getLayers()[0];
                var model = [];
                if (layer) {
                    if (layer._latlng) {
                        model = {
                            lat: layer._latlng.lat,
                            lng: layer._latlng.lng,
                        }
                    } else if (layer._latlngs.length > 1) {
                        for (var i in layer._latlngs) {
                            model.push({
                                id: i,
                                lat: layer._latlngs[i].lat,
                                lng: layer._latlngs[i].lng
                            });
                        }
                    }
                }

                window["@wrapID"]._bindAccuratePoly(model, function (e) {
                    var wrap = window["@wrapID"];
                    $("#@latlngPolyWndID").data("kendoWindow").close();
                    wrap.clearMap();
                    var latlngs = wrap._arraylatlngsToDoubles(e.sender._data);
                    var wkt = wrap.latlngsToWKT(latlngs, true);
                    if (wkt) {
                        if (wrap.allows.point || latlngs.length > 1) {
                            wrap.draw(wkt, true);
                        } else if (latlngs.length && latlngs[0].lat && latlngs[0].lng) {
                            window["@wrapID"].map.panTo(latlngs[0]);
                        }
                        wrap.setGetAddressOfPolygonByCenter(latlngs);
                    }
                });
            },
            _onAccuratePolylineOpen: function (e) {
                var layer = window["@wrapID"].layers.objectLayers.getLayers()[0];
                var model = [];
                if (layer) {
                    if (layer._latlng) {
                        model = {
                            lat: layer._latlng.lat,
                            lng: layer._latlng.lng,
                        }
                    } else if (layer._latlngs.length > 1) {
                        for (var i in layer._latlngs) {
                            model.push({
                                id: i,
                                lat: layer._latlngs[i].lat,
                                lng: layer._latlngs[i].lng
                            });
                        }
                    }
                }
                window["@wrapID"]._bindAccuratePoly(model, function (e) {
                    $("#@latlngPolyWndID").data("kendoWindow").close();
                    window["@wrapID"].clearMap();
                    var latlngs = window["@wrapID"]._arraylatlngsToDoubles(e.sender._data);
                    var wkt = window["@wrapID"].latlngsToWKT(latlngs, false);
                    if (wkt) {
                        if (window["@wrapID"].allows.point || latlngs.length > 1) {
                            window["@wrapID"].draw(wkt, true);
                        } else if (latlngs.length && latlngs[0].lat && latlngs[0].lng) {
                            window["@wrapID"].map.panTo(latlngs[0]);
                        }
                        window["@wrapID"].setGetAddressOfPolygonByCenter(latlngs);
                    }
                });
            },
            _arraylatlngsToDoubles: function (latlngs) {
                var result = [];
                for (var i = 0; i < latlngs.length; i++) {
                    result.push({
                        lat: parseFloat(latlngs[i].lat),
                        lng: parseFloat(latlngs[i].lng)
                    });
                }
                return result;
            },
            setPoint: function (latlng, focus) {
                var self = this;
                self.clearMap();
                if (focus) {
                    self.map.panTo(latlng);
                }
                L.marker([latlng.lat, latlng.lng]).addTo(self.layers.objectLayers);
            },
            draw: function (wktString, focus) {
                var self = this;
                var wkt = new Wkt.Wkt();
                wkt.read(wktString);
                var geoObj = wkt.toObject(self.map.defaults);
                //if (wkt.type === 'polygon' || wkt.type === 'linestring') {
                //}
                geoObj.addTo(self.map);
                self.layers.objectLayers.addLayer(geoObj);

                if (focus) {
                    self.focus(geoObj);
                }
            },
            focus: function (layer) {
                var self = window["@wrapID"];

                setTimeout(function () {
                    if (!layer) {
                        layer = self.layers.objectLayers.getLayers()[0];
                    }
                    if (layer) {
                        if (layer.getBounds !== undefined && typeof layer.getBounds === 'function') {
                            self.map.fitBounds(layer.getBounds());
                        } else {
                            if (layer.getLatLng !== undefined && typeof layer.getLatLng === 'function') {
                                self.map.panTo(layer.getLatLng());
                            }
                        }
                    }
                }, 200);
            },

            latlngsToWKT: function (latlngs, isPolygon) {
                if (latlngs.length == 1) {
                    return "POINT(" + latlngs[0].lng + " " + latlngs[0].lat + ")";
                }

                var lng, lat, coords = [];
                for (var i = 0; i < latlngs.length; i++) {
                    coords.push(latlngs[i].lng + " " + latlngs[i].lat);
                    if (i === 0) {
                        lng = latlngs[i].lng;
                        lat = latlngs[i].lat;
                    }
                };
                if (isPolygon) {
                    return "POLYGON((" + coords.join(",") + "," + lng + " " + lat + "))";
                } else {
                    return "LINESTRING(" + coords.join(",") + ")";
                }
            },
            toWKT: function (layer) {
                var lng, lat, coords = [];
                if (layer instanceof L.Polygon || layer instanceof L.Polyline) {
                    var latlngs = layer.getLatLngs();
                    for (var i = 0; i < latlngs.length; i++) {
                        coords.push(latlngs[i].lng + " " + latlngs[i].lat);
                        if (i === 0) {
                            lng = latlngs[i].lng;
                            lat = latlngs[i].lat;
                        }
                    };
                    if (layer instanceof L.Polygon) {
                        return "POLYGON((" + coords.join(",") + "," + lng + " " + lat + "))";
                    } else if (layer instanceof L.Polyline) {
                        return "LINESTRING(" + coords.join(",") + ")";
                    }
                } else if (layer instanceof L.Marker) {
                    return "POINT(" + layer.getLatLng().lng + " " + layer.getLatLng().lat + ")";
                }
            },
            initialize: function () {
                var self = this;
                self.map = L.map('@mapID', {
                    zoomAnimation: false
                }).on("mousemove", self.onMapMouseMove);

                console.log(self.map);


                self.layers.yandex = new L.Yandex();
                self.layers.OSM = L.tileLayer(self.osmTileURL, {
                    maxZoom: 18
                }).addTo(self.map);
                self.map.addControl(new L.Control.Layers({
                    "Слой 2": self.layers.yandex,
                    "Слой 1": self.layers.OSM
                }, null, { position: "bottomright" }));

                if (self.allows.point || self.allows.polyline || self.allows.poloygon) {
                    var accurateEditButton = new L.control({ position: 'topright' });
                    var $div;
                    accurateEditButton.onAdd = function (map) {
                        this._div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-accurate');
                        $div = $(this._div);
                        if (self.allows.point) {
                            $("<a />", {
                                href: "#",
                                title: "Точка",
                                "class": "accurate-point-btn",
                            }).on("click", window['@wrapID'].openAccuratePointWindow).appendTo($div);
                        }

                        if (self.allows.polyline) {
                            $("<a />", {
                                href: "#",
                                title: "Ломанная",
                                "class": "accurate-polyline-btn",
                            }).on("click", window['@wrapID'].openAccuratePolylineWindow).appendTo($div);
                        }

                        if (self.allows.poloygon) {
                            $("<a />", {
                                href: "#",
                                title: "Полигон",
                                "class": "accurate-poloygon-btn",
                            }).on("click", window['@wrapID'].openAccuratePolygonWindow).appendTo($div);
                        }
                        return this._div;
                    };
                    accurateEditButton.addTo(self.map);

                    $("<div />", {
                        text: "Ввод координат",
                        "class": "accurate-label"
                    }).prependTo($div.parent());
                }
                self.layers.objectLayers = new L.FeatureGroup();
                self.map.addLayer(self.layers.objectLayers);
                self.drawControl = new L.Control.Draw({
                    draw: {
                        position: 'topleft',
                        marker: self.allows.point,
                        polyline: self.allows.polyline,
                        polygon: self.allows.poloygon,
                        rectangle: false,
                        circle: false
                    },
                    edit: {
                        featureGroup: self.layers.objectLayers
                    }
                });
                self.map.addControl(self.drawControl);
                self.map.on('draw:created', function (e) {
                    self.clearMap();
                    self.layers.objectLayers.addLayer(e.layer);
                    if (e.layerType === 'marker') {
                        self.getPointAddress({
                            lat: e.layer._latlng.lat,
                            lng: e.layer._latlng.lng
                        }, function (data) {
                            console.log($("#@wrapID").closest("form").data("pbaForm"));

                            $("#@wrapID").closest("form").data("pbaForm").setPr("@(addressHtmlFieldName).Lang.ru", data.GeoObject.metaDataProperty.GeocoderMetaData.text);
                        });
                    } else if (e.layerType === "polygon" || e.layerType === "polyline") {
                        self.setGetAddressOfPolygonByCenter(e.layer._latlngs);
                    }
                });
                self.map.setView(self.defaultLatLng, 12);
            },
            setGetAddressOfPolygonByCenter: function (latlngs) {
                var self = this;
                var center = self.getCenter(latlngs);
                this.getPointAddress(center, function (data) {
                    var geoObject = null;
                    for (var i in data) {
                        var lowerCorner = data[i].GeoObject.boundedBy.Envelope.lowerCorner.split(" ");
                        var upperCorner = data[i].GeoObject.boundedBy.Envelope.upperCorner.split(" ");
                        var allIn = true;
                        for (var j in latlngs) {
                            if (latlngs[j].lat > upperCorner[1] || latlngs[j].lat < lowerCorner[1] || latlngs[j].lng > upperCorner[0] || latlngs[j].lng < lowerCorner[0]) {
                                allIn = false;
                                break;
                            }
                        }
                        if (allIn) {
                            geoObject = data[i];
                            break;
                        }
                    }
                    if (geoObject) {
                        $("#@wrapID").closest("form").data("pbaForm").setPr("@(addressHtmlFieldName).Lang.ru", geoObject.GeoObject.metaDataProperty.GeocoderMetaData.text);
                    } else {
                        $("#@wrapID").closest("form").data("pbaForm").setPr("@(addressHtmlFieldName).Lang.ru", "");
                    }
                }, true);
            },
            getCenter: function (points) {
                if (points.length == 1) {
                    return points[0];
                }
                if (points.length == 2) {
                    return {
                        lat: (points[0].lat + points[1].lat) / 2,
                        lng: (points[0].lng + points[1].lng) / 2,
                    }
                }
                var i, j, len, p1, p2, f, area, x, y,
                area = x = y = 0;
                for (i = 0, len = points.length, j = len - 1; i < len; j = i++) {
                    p1 = points[i];
                    p2 = points[j];

                    f = p1.lat * p2.lng - p2.lat * p1.lng;
                    x += (p1.lng + p2.lng) * f;
                    y += (p1.lat + p2.lat) * f;
                    area += f * 3;
                }
                return window["@wrapID"].map.layerPointToLatLng([x / area, y / area]);
            },
            onPlaceSelect: function (e) {
                var dataItem = this.dataItem(e.item.index());
                var latlng = dataItem.GeoObject.Point.pos.split(" ");
                if (window["@wrapID"].allows.point) {
                    window["@wrapID"].setPoint({
                        lat: latlng[1],
                        lng: latlng[0]
                    }, true);
                } else {
                    window["@wrapID"].map.panTo({
                        lat: latlng[1],
                        lng: latlng[0]
                    });
                }
            },
            getPointAddress: function (latlng, callback, all) {
                $.get(window["@wrapID"].reverseSearchURL, {
                    format: "json",
                    geocode: latlng.lng + "," + latlng.lat
                }, function (data) {
                    if (callback && data.response.GeoObjectCollection.featureMember.length) {
                        if (all) {
                            callback(data.response.GeoObjectCollection.featureMember);
                        } else {
                            callback(data.response.GeoObjectCollection.featureMember[0]);
                        }
                    }
                });
            },
        }

        $("#@wrapID").closest("[data-role=window]").data('kendoWindow').bind('activate', function () {
            if (window["@wrapID"].map) {
                window["@wrapID"].map._onResize();
                window["@wrapID"].focus();
            }
        });

        $("#@wrapID").closest("[data-role=window]").data('kendoWindow').bind('resize', function () {
            if (window["@wrapID"].map) {
                window["@wrapID"].map._onResize();
            }
        });

        var tabId = $("#@wrapID").closest('.tab-pane').attr('id');
        $('a[href="#' + tabId + '"]').on('shown.bs.tab', function (e) {
            if (window["@wrapID"].map) {
                window["@wrapID"].map._onResize();
                setTimeout(window["@wrapID"].focus, 200);
            }
        });

        $("#@wrapID").closest("form").on("onShown", function (e, form) {
            if (window["@wrapID"].map) {
                window["@wrapID"].map._onResize();
                setTimeout(window["@wrapID"].focus, 200);
            }
        });

        $("#@wrapID").closest("form").on("onAfterBind", function (e, form) {
            if (!window["@wrapID"].map) {
                window["@wrapID"].initialize();
                $('.leaflet-control-attribution').remove();
            } else {
                window["@wrapID"].clearMap();
                // Тут как то так
                var drawControl = window["@wrapID"].drawControl;
                if (drawControl) {
                    for (var i in drawControl._toolbars) {
                        if (typeof drawControl._toolbars[i]._modes.edit != 'undefined') {
                            var editHandler = drawControl._toolbars[i]._modes.edit.handler;
                            editHandler.enable();
                            editHandler.disable();
                        }
                    }
                }
            }

            var address = form.getPr("@(addressHtmlFieldName).Lang.ru");
            var wkt = form.getPr("@(htmlFieldName).Disposition.Geography.WellKnownText");
            if (wkt) {
                window["@wrapID"].draw(wkt, true);
            }
            $("#@addressWrapID").find("#@addressInputID").val(address);
        });

        $("#@wrapID").closest("form").on("onSave", function (e, form) {
            var layer = window["@wrapID"].layers.objectLayers.getLayers()[0];

            if (layer) {
                form.setPr("@(htmlFieldName).Disposition", window["@wrapID"].toWKT(layer));
            }

            console.log('save');
        });

        $("#@addressWrapID").find("#@addressInputID").kendoAutoComplete({
            dataTextField: "GeoObject.metaDataProperty.GeocoderMetaData.text",
            minLength: 4,
            dataSource: {
                type: "json",
                serverFiltering: true,
                transport: {
                    read: window["@wrapID"].searchURL,
                    parameterMap: function (data, action) {
                        return "format=json&geocode=" + data.filter.filters[0].value;
                    }
                },
                schema: {
                    data: function (response) {
                        return response.response.GeoObjectCollection.featureMember;
                    }
                }
            },
            select: window["@wrapID"].onPlaceSelect,
        });

        $(".geosearch-wrapper .glyphicon-remove").on("click", function () {
            window["@wrapID"].clearMap();
            $("#@addressWrapID").find("#@addressInputID").val("");
        });

        $("#@mapID").on("DOMNodeInserted", ".ymaps-copyrights-pane", function () {
            $(this).remove();
        });
    });
</script>
