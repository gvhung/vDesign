@model StandartDialogViewModel
@using Newtonsoft.Json
@using Base.UI;

@{
    bool isRead = Model.IsPermission(Base.Security.TypePermission.Read);
    bool isWrite = Model.IsPermission(Base.Security.TypePermission.Write) && !Model.IsReadOnly;
    bool isReadOnly = !isWrite;

    Type typeEntity = Model.ViewModelConfig.TypeEntity;

    bool isCategorizedItem = typeEntity.GetInterfaces().Contains(typeof(ICategorizedItem));

    string detailView = "CommonEditor";

    if (Model.HasDetailView)
    {
        detailView = Model.ViewModelConfig.DetailView.Name;
    }

    ViewDataDictionary VD = new ViewDataDictionary();

    VD.Add("ViewModelConfig", Model.ViewModelConfig);

    string customQueryGetUrl = "";
    string customQueryGetParams = null;

    string querySaveUrl = Url.Action("Save", "Standart", new { area = "" });

    if (Model.ViewModelConfig.DetailView != null && Model.ViewModelConfig.DetailView.DataSource != null)
    {
        DataSourceAction actionGet = Model.ViewModelConfig.DetailView.DataSource.Get;

        if (actionGet != null)
        {
            customQueryGetUrl = Url.Action(actionGet.Name, actionGet.Controller);
            customQueryGetParams = JsonConvert.SerializeObject(actionGet.Params);
        }

        DataSourceAction actionSave = Model.ViewModelConfig.DetailView.DataSource.Save;

        if (actionSave != null)
        {
            querySaveUrl = Url.Action(actionSave.Name, actionSave.Controller, new { area = "" });
        }
    }
}

@if (isRead)
{
    <script>
        window["@Model.DialogID"] = new CompositeControl("@Model.DialogID");

        (function () {
            var composite = window["@Model.DialogID"];

            composite.count = 0;
            composite.Idx = {};
            composite.prevID = null;
            composite.nextID = null;
            composite.mnemonic = "@Model.Mnemonic";
            composite.type = "@Model.Type";
            composite.isModal = composite.type == "Modal";
            composite.changeObjects = [];
            composite.isAjaxForm = @((Model.ViewModelConfig.DetailView.AjaxForm != null).ToString().ToLower());

            composite.defparams = {
                // kendoWindow - окно диалога
                wnd: null,
                // ID текущего объекта
                currentID: 0,
                // ассоциативный массив - / key = ID; value = { model: entity, access: { Update: bool, Delete: bool }, order: №, loaded: bool } /
                entities: {},
                // pbaForm - ссылка на родительскую форму
                parentForm: null,
                // флаг - только чтение
                isReadOnly: $.parseJSON("@(isReadOnly.ToString().ToLower())"),
                // флаг - выполнить запрос сохранения объекта
                toSave: false,
                // флаг - скрыть toolbar
                hideToolbar: $.parseJSON("@Model.ViewModelConfig.DetailView.HideToolbar.ToString().ToLower()"),
                // события
                events: {
                    initNewEntity: function (e) { },
                    beforeSave: function (e) { },
                    save: function (e) { },
                },
                // параметры для кастомных запросов
                customQueryParams: {
                    get: {},
                    save: {}
                },
                // наименование кнопок
                buttons: null
            };

            composite.params = {};

            composite.initDialog = function (params) {
                var defparams = $.extend({}, this.defparams);

                this.params = $.extend(defparams, params);

                if (this.defparams.isReadOnly)
                    this.params.isReadOnly = true;

                this.count = 0;
                this.changeObjects = [];

                for (var id in this.params.entities) {
                    var entity = this.params.entities[id];
                    this.Idx[entity.order] = parseInt(id);
                    this.count++;
                }

                if (this.params.hideToolbar || composite.defparams.hideToolbar) {
                    this.element().find(".toolbar-vm").hide();
                    this.element().find(".view-model").css("top", "5px");
                }


                this.element().find(".view-model .common-editor-tabs").each(function () {
                    var $tabs = $(this);

                    if ($tabs.children('li').length == 1) {
                        $tabs.closest('.common-form').addClass('hidden-tabs');
                    }
                });

                this.bind();
            };

            composite.destroy = function () {
                this.changeObjects = [];
            };

            composite.getEditorViewModel = function () {
                return this.getWidget("EditorViewModel");
            };

            composite.getDisplayViewModel = function () {
                return this.getWidget("DisplayViewModel");
            };

            composite.criticalError = function (msg) {
                this.hideLoading();
                this.element().html("<h4 style='color: red;'>" + msg + "</h4>");
            };

            composite.startLoading = function () {
                var $content;

                if (this.isModal)
                    $content = this.params.wnd.element;
                else
                    $content = this.element().closest("div");

                $content.addClass("wnd-loading-content");

                this.element().hide();
            };

            composite.hideLoading = function () {
                var $content;

                if (this.isModal)
                    $content = this.params.wnd.element;
                else
                    $content = this.element().closest("div");

                $content.removeClass("wnd-loading-content");

                this.element().fadeIn(300);

                var editors = [composite.getEditorViewModel(), composite.getDisplayViewModel()];

                for(var i in editors) {
                    var editor = editors[i];

                    if (editor && editors.hasOwnProperty(i)) {
                        var $el = editor.element();

                        if($el.is(":visible"))
                            $el.trigger('onShown', editor.widget());
                    }
                }
            };

            composite.getCurrentEntity = function () {
                return composite.params.entities[composite.params.currentID];
            };

            composite.getCurrentModel = function () {
                return composite.getCurrentEntity().model;
            };

            composite.setCurrentModel = function (model) {
                composite.getCurrentEntity().model = model;
                composite.changeObjects.push(composite.getCurrentModel());
            };

            composite.bind = function () {
                this.startLoading();

                this.getModel(function (entity) {
                    var dfds = [];

                    composite.prevID = null;
                    composite.nextID = null;

                    if (composite.params.currentID != 0 && composite.count > 1) {

                        if (entity.order > 0) {
                            composite.prevID = composite.Idx[entity.order - 1];
                        }

                        if (entity.order < (composite.count - 1)) {
                            composite.nextID = composite.Idx[entity.order + 1];
                        }
                    }

                    for (var id in composite.widgets) {
                        if ("asyncBind" in composite.widgets[id]) {
                            dfds.push(composite.widgets[id].asyncBind({
                                isReadOnly: !composite.getAccess(entity).Update,
                                parentForm: composite.params.parentForm,
                                model: entity.model,
                                prevID: composite.prevID,
                                nextID: composite.nextID,
                                toSave: composite.params.toSave,
                                buttons: composite.params.buttons
                            }));
                        }
                    }

                    $.when.apply($, dfds).done(function () {
                        composite.hideLoading();
                    });
                });
            };

            composite.getAccess = function (obj) {
                if (this.params.isReadOnly) {
                    return { Update: false, Delete: false };
                }
                else {
                    return obj.access || { Update: true, Delete: true };
                }
            };


            composite.getModel = function (callback) {
                var currentID = this.params.currentID;
                var entities = this.params.entities;

                if (currentID in entities) {
                    if (entities[currentID].model) {
                        callback(entities[currentID]);
                        return;
                    }
                }

                var isNew = !currentID || currentID == 0;

                var queryParams = composite.queryGetParams();

                if(queryParams){
                    var initEntity = function(res){
                        if (isNew && composite.params.events.initNewEntity)
                            composite.params.events.initNewEntity(res.model);

                        if (!(currentID in entities)) {
                            entities[currentID] = {};
                        }

                        var entity = entities[currentID];

                        entity.model = res.model;
                        entity.access = res.access;
                        entity.loaded = true;

                        return entity;
                    };

                    if(!isNew && composite.isAjaxForm){
                        var res = { model: { ID: currentID }, access: null };

                        callback(initEntity(res));
                    }else{
                        $.get(queryParams.url, queryParams.params, function (res) {
                            if (res.error && res.error != 0) {

                                composite.criticalError(res.message);

                                return;
                            }
                            else {
                                callback(initEntity(res));
                            }
                        });
                    }
                }
            };


            composite.prev = function () {
                if (composite.prevID) {
                    composite.params.currentID = composite.prevID;
                    composite.bind();
                }
                else {
                    composite.refresh();
                }
            };

            composite.next = function () {
                if (composite.nextID) {
                    composite.params.currentID = composite.nextID;
                    composite.bind();
                }
                else {
                    composite.refresh();
                }
            };

            composite.onChildWidgetChanged = function (e) {
                if (e.sender.desc == "ToolbarViewModel") {
                    switch (e.event) {
                        case "prev":
                            composite.prev();
                            break;
                        case "next":
                            composite.next();
                            break;
                        case "refresh":
                            composite.refresh();
                            break;
                        case "save":
                            if (composite.getAccess(composite.getCurrentEntity()).Update) {
                                $.when(composite.save(false)).done(function() {
                                    $.when(e.params.callback()).done(function() {
                                        composite.refresh();
                                    });
                                });
                            } else {
                                $.when(e.params.callback()).done(function () {
                                    composite.changeObjects.push(composite.getCurrentModel());
                                    composite.refresh();
                                });
                            }

                            break;

                        case "loadingAndRefresh":
                        case "loadingAndNext":
                            composite.startLoading();

                            composite.changeObjects.push(composite.getCurrentModel());

                            $.when(e.params.callback(false)).done(function () {
                                if (e.event == "loadingAndRefresh")
                                    composite.refresh();
                                else
                                    composite.next();
                            });

                            break;
                        case "addToChangedAndRefresh":
                            composite.changeObjects.push(composite.getCurrentModel());
                            composite.refresh();

                            break;
                    }

                } else if (e.sender.desc == "EditorViewModel") {
                    switch (e.event) {
                        case "save":
                        case "apply":

                            $.when(composite.save(true)).done(function () {
                                if(e.event == "save")
                                    composite.params.events.save({ sender: composite });
                                else
                                    composite.bind();
                            });

                            break;

                        case "close":
                            composite.params.wnd.close();

                            break;
                    }
                } else if (e.sender.desc == "DisplayViewModel") {
                    if (e.event == "close") {
                        composite.params.wnd.close();
                    }
                }
            };

            composite.refresh = function () {
                var entity = composite.params.entities[composite.params.currentID];

                if (entity.loaded) {
                    entity.model = null;
                }

                composite.bind();
            };

            composite.save = function (sync) {
                var dfd = $.Deferred();

                var editor = this.getEditorViewModel();

                var form = editor.widget();

                editor.element().trigger("onSave", form);

                var model = form.getModel();

                if (this.params.events.beforeSave) {
                    this.params.events.beforeSave({
                        isNew: model.ID == 0,
                        pbaForm: form
                    });
                }

                if (form.validate()) {
                    editor.element().trigger("onAfterValidate", form);

                    if (this.params.toSave) {

                        this.startLoading();;

                        $.ajax({
                            type: "POST",
                            url: "@querySaveUrl",
                            data: JSON.stringify({ mnemonic: "@Model.Mnemonic", model: model, returnEntireModel: sync }),
                            contentType: "application/json; charset=utf-8",
                            success: function (res) {
                                if (res.error == 0) {
                                    composite.changeObjects.push(res.model);

                                    if (!composite.isModal)
                                        pbaAPI.infoUploadSuccess(res.message);

                                    if (sync) {
                                        if (composite.params.currentID == 0) {
                                            var entity = $.extend({}, composite.params.entities[0]);

                                            delete composite.params.entities[0];

                                            entity.model = res.model;
                                            entity.loaded = true;

                                            if (res.access)
                                                entity.access = res.access;

                                            composite.params.entities[res.model.ID] = entity;
                                            composite.Idx[entity.order] = res.model.ID;

                                            composite.params.currentID = res.model.ID;
                                        } else {
                                            var entity = composite.params.entities[composite.params.currentID];

                                            entity.model = res.model;

                                            if (res.access)
                                                entity.access = res.access;
                                        }
                                    }

                                    dfd.resolve();
                                } else {
                                    pbaAPI.errorMsg(res.message);

                                    composite.hideLoading();
                                }
                            }
                        });
                    } else {
                        composite.changeObjects.push(model);

                        dfd.resolve();
                    }
                } else {
                    pbaAPI.errorMsg("Заполнены не все обязательные поля!");
                }

                return dfd.promise();
            };
        })();
    </script>
}
else
{
    <script>
        window["@Model.DialogID"] = new CompositeControl("@Model.DialogID");

        (function () {
            var composite = window["@Model.DialogID"];

            composite.mnemonic = "@Model.Mnemonic";
            composite.type = "@Model.Type";
            composite.isModal = composite.type == "Modal";
            composite.changeObjects = [];

            composite.initDialog = function (params) {
                composite.hideLoading(params);
            };

            composite.getCurrentModel = function () {
                return {};
            };

            composite.hideLoading = function (params) {
                var $content;

                if (this.isModal)
                    $content = params.wnd.element;
                else
                    $content = this.element().closest("div");

                $content.removeClass("wnd-loading-content");

                this.element().fadeIn(300);
            };

            composite.destroy = function () {
                this.changeObjects = [];
            };
        })();
    </script>
}

@if (customQueryGetParams != null)
{
    <script>
        (function () {
            var composite = window["@Model.DialogID"];

            composite.queryGetParams = function () {
                var url = "@customQueryGetUrl";
                var params = @Html.Raw(customQueryGetParams);


                if(!composite.params.customQueryParams || !composite.params.customQueryParams.get){
                    composite.criticalError("Ошибка инициализации параметров get запроса");
                    return null;
                }

                return {
                    url: "@customQueryGetUrl",
                    params: pbaAPI.replaceObjectPlaceholders(composite.params.customQueryParams.get, params)
                }
            };
        })();
    </script>
}
else
{
    <script>
        (function () {
            var composite = window["@Model.DialogID"];

            composite.queryGetParams = function () {
                var action, params;
                var currentID = this.params.currentID;
                var entities = this.params.entities;

                if (currentID in entities) {
                    if (entities[currentID].model) {
                        callback(entities[currentID]);
                        return;
                    }
                }

                var isNew = !currentID || currentID == 0;

                if (isNew) {
                    action = "CreateOnGroundsOf";
                    params = {
                        baseMnemonic: this.mnemonic,
                        destMnemonic: this.mnemonic
                    };
                } else {
                    if (currentID in entities) {
                        action = "Get";
                        params = {
                            mnemonic: this.mnemonic,
                            id: currentID
                        };

                    } else {
                        composite.criticalError("Ошибка инициализации текущей модели");
                        return null;
                    }
                }

                return {
                    url: application.url.GetStandart(action),
                    params: params,
                };
            };
        })();
    </script>
}


<div id="@Model.DialogID" style="display:none;" class="dialog-vm">
    @Html.HiddenFor(m => m.DialogID)

    @if (isRead)
    {
        <div class="toolbar-vm">
            @{ Html.RenderPartial("_ToolbarViewModel", new StandartViewModel(Model)); }
        </div>
        <div class="view-model">
            @if (isWrite)
            {
                Html.RenderPartial("_EditorViewModel", new StandartFormModel(Model, Html.GetCommonEditor(Model.Mnemonic)));
            }

            @{ Html.RenderPartial("_DisplayViewModel", new StandartFormModel(Model, Html.GetCommonEditor(Model.Mnemonic))); }


            @if (!String.IsNullOrEmpty(Model.ViewModelConfig.DetailView.CSHtmlHelper))
            {
                Html.RenderPartial(Model.ViewModelConfig.DetailView.CSHtmlHelper, new StandartViewModel(Model));
            }
        </div>
    }
    else
    {
        <div class="lock" style="min-height:200px;"><h2>НЕТ ДОСТУПА</h2></div>
    }
</div>

<script>
    $(function () {
        var dialog = window["@Model.DialogID"];

        $("#@Model.DialogID").data("dialogVM", dialog);
    });
</script>


@if (ViewBag.AutoBind != null && ViewBag.AutoBind)
{
    <script>
        $(function () {
            var dialog = window["@Model.DialogID"];
            var id = parseInt("@ViewBag.ID");

            var entities = {};

            entities[id] = { model: null, order: 0 };

            dialog.initDialog({
                currentID: parseInt("@ViewBag.ID"),
                entities: entities,
                toSave: true,
            });
        });
    </script>
}