@model WebUI.Models.Task.TaskToolbarVm

@{
    string wrapid = "w_" + Guid.NewGuid().ToString("N");
    string templateid = "t_" + Guid.NewGuid().ToString("N");

    Type enumType = typeof(Base.Task.Entities.TaskStatus);
}

<style>
    .action-comment {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
    }

    .data-user-wrap {
        margin-bottom: 10px !important;
    }

    .performers a {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
    }
</style>

<script>
    window["@wrapid"] = {
        _exeAction: function (actionID, comment, callback) {
            return $.ajax({
                type: "POST",
                url: "@Url.Action("ExecuteAction", "Task")",
                data: {
                    taskID: '@Model.TaskID',
                    actionID: actionID,
                    comment: comment
                },
                success: function (data) {
                    if (data.error) {
                        pbaAPI.errorMsg(data.message);
                    } else {
                        if (callback)
                            callback();
                    }   
                }
            });
        },
        executeAction: function (actionID, commentIsRequired) {
            if (commentIsRequired == "true") {
                var $wnd = $("<div />").kendoWindow({
                    title: "Комментарий",
                    resizable: true,
                    width: 500,
                    height: 300,
                    modal: true,
                    deactivate: function () {
                        this.destroy();
                    }
                });

                var wnd = $wnd.data("kendoWindow");

                wnd.content($("#@templateid").html()).center().open();

                $wnd.find('textarea.action-comment').on("keyup", function (e) {
                    var invokeButton = $wnd.find("[data-action=invoke]");
                    if (e.target.value) {
                        invokeButton.removeClass('disabled');
                    } else if (!invokeButton.hasClass('disabled')) {
                        invokeButton.addClass('disabled');
                    }
                }).on("copy cut paste", function (e) {
                    setTimeout(function () {
                        var invokeButton = $wnd.find("[data-action=invoke]");
                        if (e.target.value) {
                            invokeButton.removeClass('disabled');
                        } else if (!invokeButton.hasClass('disabled')) {
                            invokeButton.addClass('disabled');
                        };
                    }, 0);
                });

                $wnd.find("[data-action=cancel]").click(function () {
                    wnd.close();
                });

                $wnd.find("[data-action=invoke]").click(function () {
                    $('#@wrapid').closest('[data-role=toolbar]').trigger('onActionInvoke', {
                        save: function () {
                            return window["@wrapid"]._exeAction(actionID, $wnd.find('textarea.action-comment').val(), function () {
                                wnd.close();
                            });
                        }
                    });
                });
            } else {
                $('#@wrapid').closest('[data-role=toolbar]').trigger('onActionInvoke', {
                    save: function () {
                        return window["@wrapid"]._exeAction(actionID, "");
                    }
                });
            }
        }

    };
</script>

<script id="@templateid" type="text/x-kendo-template">
    <div style="display:none" class="panel panel-default data-user-wrap">
        <div data-user class="panel-body">
        </div>
    </div>
    <textarea class="form-control action-comment" rows="10" placeholder="Введите комментарий"></textarea>
    <div style="position:absolute; bottom: 10px; right:10px;">
        <button data-action="cancel" type="button" class="btn btn-default">Отменить</button>
        <button data-action="invoke" type="button" class="btn btn-primary disabled">Выполнить</button>
    </div>
</script>

<div id="@wrapid" class="btn-group">
    @foreach (var action in Model.Actions)
{
    <button type="button" class="btn btn-default" title="@action.Text" onclick="window['@wrapid'].executeAction('@action.Value', '@action.СommentIsRequired.ToString().ToLower()');"><span class='enum-@enumType.Name' data-val='@action.Value'></span> @action.Title</button>
}
</div>